<!DOCTYPE html>
<html class="no-js" lang="" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/Layout">
<!-- Mirrored from html.themewant.com/ekomart/cart.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 01 Nov 2024 06:32:08 GMT -->
<head>
<meta charset="UTF-8">
<meta name="description"
	content="Ekomart-Grocery-Store(e-Commerce) HTML Template: A sleek, responsive, and user-friendly HTML template designed for online grocery stores.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="keywords" content="Grocery, Store, stores">
<title>Ekomart-Grocery-Store(e-Commerce) HTML Template</title>
<link rel="shortcut icon" type="image/x-icon"
	href="/view/images/fav.png">
<!-- plugins css -->
<link rel="stylesheet preload" href="/view/css/plugins.css" as="style">
<link rel="stylesheet preload" href="/view/css/style.css" as="style">

</head>

<body>
	<!-- rts header area start -->
	<!-- rts header area start -->
	<div th:replace="~{page/fragments/header::header}"></div>
	<!-- rts header area end -->
	<!-- rts header area start -->
	<!-- header style two -->
	<!-- header style two End -->
	<!-- rts header area end -->
	<!-- rts header area end -->
	<div class="rts-navigation-area-breadcrumb bg_light-1">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="navigator-breadcrumb-wrapper">
						<a href="index.html">Home</a> <i
							class="fa-regular fa-chevron-right"></i> <a class="current"
							href="index.html">Blog Lists With Sidebar</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="section-seperator bg_light-1">
		<div class="container">
			<hr class="section-seperator">
		</div>
	</div>
	<!-- rts cart area start -->
	<div class="rts-cart-area rts-section-gap bg_light-1">
		<div class="container-payment">
			<div class="row g-5">
				<div
					class="col-xl-12 col-lg-12 col-md-12 col-12 order-2 order-xl-1 order-lg-2 order-md-2 order-sm-2">
					<div class="cart-area-main-wrapper">
						<div class="cart-top-area-note">
							<div
								style="display: flex; align-items: center; justify-content: space-between;">
								<div style="font-size: 35px; margin: 0; width: 90%;">Địa
									chỉ giao hàng</div>
								<div style="width: 10%;">
									<button type="button" class="btn btn-primary"
										data-bs-toggle="modal" data-bs-target="#deliveryModal"
										style="display: flex; align-items: center; padding: 5px 10px; font-size: 16px; cursor: pointer;">
										Thêm địa chỉ</button>
									<div class="modal fade" id="deliveryModal"
										data-bs-backdrop="static" data-bs-keyboard="false"
										tabindex="-1" aria-labelledby="deliveryModalLabel"
										aria-hidden="true">
										<div class="modal-dialog">
											<div class="modal-content" style="height: 520px">
												<!-- Modal Header -->
												<div class="modal-header">
													<h5 class="modal-title" id="deliveryModalLabel">Nhập
														Địa Chỉ Giao Hàng</h5>
													<button type="button" class="btn-close"
														data-bs-dismiss="modal" aria-label="Close"></button>
												</div>

												<!-- Modal Body -->
												
													<div class="modal-body">
														<div class="mb-3">
															<label for="fullname" class="form-label">Họ và
																Tên:</label> <input type="text" class="form-control" id="uname"
																name="uname" required style="border: solid 2px #ddd;">
														</div>
														<div class="mb-3">
															<label for="phone" class="form-label">Số Điện
																Thoại:</label> <input type="text" class="form-control"
																id="phone" name="phone" required
																style="border: solid 2px #ddd;">
														</div>
														<div class="mb-3">
															<label for="address" class="form-label">Địa Chỉ:</label>
															<input type="text" class="form-control" id="detail"
																name="detail" required style="border: solid 2px #ddd";>
														</div>
														<div class="mb-3"
															style="display: flex; align-items: center; padding: 12px 0px;">
															<label for="province" class="form-label"
																style="padding-right: 15px; font-size: 20px; width: 50%;">Tỉnh/Thành
																Phố:</label> <select id="province" name="province" required
																style="font-size: 20px;">
																<option value="">Chọn Tỉnh/Thành Phố</option>
															</select>
														</div>
														<div class="mb-3"
															style="display: flex; align-items: center; padding: 12px 0px;">
															<label for="district" class="form-label"
																style="padding-right: 15px; font-size: 20px; width: 50%;">Quận/Huyện:</label>
															<select id="district" name="district"
																style="font-size: 20px;" required>
																<option value="" selected>Chọn Quận/Huyện</option>
															</select>
														</div>
														<div class="mb-3"
															style="display: flex; align-items: center; padding: 12px 0px;">
															<label for="ward" class="form-label"
																style="padding-right: 15px; font-size: 20px; width: 50%;">Phường/Xã:</label>
															<select id="ward" name="ward" required
																style="font-size: 20px;">
																<option value="" selected>Chọn Phường/Xã</option>
															</select>
														</div>
														<button type="button"   class="saveAddressBtn btn btn-primary"
															style="width: 30%; font-size: 15px; padding: 10px;">
															Xác Nhận Địa Chỉ</button>

													</div>
												
											</div>
										</div>
									</div>
								</div>

							</div>
							<div class='row row-address' style="margin-top: 15px;">
								<div class="col-6 address" style="margin-right: 15px;" th:each="address : ${addressUser}">
									<div class=" align-items-start"
										style="padding: 10px; height: 100%">
										<div style="padding: 10px; height: 80%">
											<input type="hidden" th:value=${address.id} id="addressid">
											<p>
												<strong th:text="${address.uname}"></strong>
											</p>
											<p th:text="${address.phone}"></p>
											<p th:text="${address.detail + ' ' + address.ward + ' ' + address.district + ' ' + address.province}"></p> 
										</div>
										<!-- Các nút Chỉnh sửa và Xóa -->
										<div class="d-flex"
											style="height: 20%; width: 100%; height: 20%; width: 100%; justify-content: flex-end; display: flex;">
											<i class="fa-solid fa-pencil-alt"
												style="padding-right: 10px;"> </i> 
											<i class="fa-solid fa-trash-alt remove-address" style="padding-right: 10px;"></i>
											<a th:text="${address.defaults == 1 ? 'Mặc định' : 'Dat lam  mặc định'}"></a>

										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="rts-cart-list-area">
						<div class="container-pro mt-4 mb-5">
							<div class="product-item">
								<div class="product-item-title">
									<h2 class="title-sp">Sản phẩm</h2>
									<div style="flex: 2"></div>
									<div class="title-sp-1">Đơn giá</div>
									<div class="title-sp-1">Số lượng</div>
									<div class="title-sp-1">Thành tiền</div>
								</div>
							</div>
							<form th:action="@{/cart/payment}" th:method="post">
								<!-- <div th:each="item, i : ${cart.items}"> -->
								<div class="product-list">
									<div th:each="product : ${selectedProducts}"
										class="product-info">
										<div class="pro-shop" th:text="${product.productName}"></div>
										<div class="product">
											<div class="product-info-1">
												<div style="flex: 4">
													<img class="img-pro"
														src="https://static0.gamerantimages.com/wordpress/wp-content/uploads/2022/11/Genshin-Impact-Nahida.jpg">

												</div>
												<span style="flex: 2">Loại: Cute pho mai que</span> <span
													class="title-sp-1" th:text="${product.productPrice}"></span>
												<span class="title-sp-1"
													th:text="${product.productQuantity}"></span> 
													<span
													id="total" class="title-sp-1"
													th:text="${product.productPrice*product.productQuantity}"></span>
											</div>
										</div>
									
									<div class="voucher-shop">
										<div></div>
										<div class="voucher-shop-info">
											<div style="display: flex; justify-content: space-between">
												<span>Voucher của Shop</span>
												<button class="btn-voucher">Chọn voucher</button>
											</div>
										</div>
									</div>
									<div class="ptvanchuyen">
										<div class="message">
											<span style="display: flex; width: 80px;">Lời nhắn:</span> <input
												class="luuy" placeholder="Lưu ý cho người bán"></input>
										</div>
										<div class="vanchuyen">
											<span style="flex: 5">Phương thức vận chuyển:</span> <span
												style="flex: 4" class="shippingMethod">Chuẩn</span>
											<button class="changeButton" type="button"
												style="flex: 4; color: #05a !important;">Thay đổi</button>
											<span style="flex: 4; text-align: right;"
												class="shippingCost">20.000</span>
										</div>
									</div>
									<div class="tongtien">
										<span>Tổng tiền: 100.000</span>
									</div>
								</div>
								</div>
							</form>

							<div style="margin-top: -13px;">
								<div class="pro-voucher">
									<span>Eko Voucher</span>
									<button class="btn-voucher">Chọn voucher</button>
								</div>
							</div>
							<div class="thanhtoantien">
								<div class="ptthanhtoan">
									<span style="display: flex; margin-right: 10px">Phương
										thức thanh toán:</span>
									<button class="btn-tt">Thanh toán bằng ngân hàng</button>
									<button class="btn-tt">Thanh toán khi nhận hàng</button>
								</div>
								<div class="thanhtoan-info">
									<div></div>
									<div>
										<div class="thanhtoan-row">
											<span class="label-tong">Tổng tiền hàng</span> <span
												class="tien-tong tien-tong-items">100.000</span>
										</div>
										<div class="thanhtoan-row">
											<span class="label-tong">Tổng tiền phí vận chuyển</span> <span
												class="tien-tong tien-tong-shipping">20.000</span>
										</div>
										<div class="thanhtoan-row">
											<span class="label-tong">Tổng thanh toán</span> <span
												class="tien-tong tien-tong-total"
												style="font-size: 20px; color: green">120.000</span>
										</div>
									</div>
								</div>
							</div>
							<div class="dathang">
								<button class="btn-dathang">Đặt hàng</button>
							</div>
							<div id="popup-vanchuyen" class="popup-vanchuyen">
								<div class="popup-content">
									<h3>Chọn phương thức vận chuyển</h3>
									<label class="option"> <input type="radio"
										name="shipping" value="Nhanh" checked> Nhanh: 20.000₫
										(Đảm bảo nhận hàng trong 3 ngày)
									</label> <label class="option"> <input type="radio"
										name="shipping" value="Hỏa Tốc"> Hỏa Tốc: 45.000₫
										(Giao hàng trong ngày)
									</label>
									<div class="buttons">
										<button class="btn btn-success confirm-button ml-2">Xác
											Nhận</button>
										<button class="btn btn-secondary close-button ml-2">Trở
											Lại</button>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
		<script>
		window.addEventListener('load', updateTotal);
		let currentMethodElement, currentCostElement;

		// Mở popup
		function openPopup(event) {
			const popup = document.getElementById("popup-vanchuyen");
			popup.style.display = "block";
			document.documentElement.classList.add("no-scroll");

			// Tìm phần tử liên quan đến sản phẩm hiện tại
			const productInfo = event.target.closest('.product-info');
			currentMethodElement = productInfo.querySelector('.shippingMethod');
			currentCostElement = productInfo.querySelector('.shippingCost');

			// Lấy phương thức vận chuyển hiện tại
			const currentMethod = currentMethodElement.textContent.trim();

			// Đồng bộ radio button với phương thức vận chuyển hiện tại
			let found = false;
			document.querySelectorAll('input[name="shipping"]').forEach(radio => {
				if (radio.value === currentMethod) {
					radio.checked = true;
					found = true;
				}
			});

			// Nếu không tìm thấy, chọn mặc định radio đầu tiên
			if (!found) {
				document.querySelector('input[name="shipping"]').checked = true;
			}
		}

		// Đóng popup
		function closePopup() {
			const popup = document.getElementById("popup-vanchuyen");
			popup.style.display = "none";
			document.documentElement.classList.remove("no-scroll");
		}
		function closeAddressModel() {
			const modal = bootstrap.Modal.getInstance(document.getElementById('deliveryModal'));
		    modal.hide();

		}
		function removeAddress() {
		    // Tìm thẻ cha gần nhất có class 'address'
		    const parentDiv = event.target.closest(".address");

		    // Lấy ID của địa chỉ từ thẻ input hidden
		    const addressId = document.getElementById("addressid").value;

		    console.log(addressId)
		    console.log(parentDiv)
		    // Gửi yêu cầu xóa đến server, chỉ gửi ID (không cần bọc trong đối tượng JSON)
		    fetch("/user/api/address/delete", {
		        method: "POST",
		        headers: {
		            "Content-Type": "application/json", // Đảm bảo là JSON
		        },
		        body: addressId, // Gửi trực tiếp ID
		    })
		    .then(response => {
		        if (response.ok) {
		            parentDiv.remove(); // Xóa thẻ cha khỏi giao diện
		        } else {
		            console.error("Có lỗi khi xóa địa chỉ.");
		        }
		    })
		    .catch(error => {
		        console.error("Có lỗi xảy ra khi xóa địa chỉ: " + error.message);
		    });
		}

		// Xác nhận và cập nhật thông tin
		function confirmSelection() {
			const selectedOption = document.querySelector('input[name="shipping"]:checked').value;

			// Cập nhật giá tiền dựa vào lựa chọn
			const priceMap = {
				"Nhanh": "20.000",
				"Hỏa Tốc": "45.000"
			};

			// Cập nhật phần tử phương thức vận chuyển và giá
			currentMethodElement.textContent = selectedOption;
			currentCostElement.textContent = priceMap[selectedOption] + "₫";
			updateTotalForOrder(currentMethodElement.closest('.product-info'));
			updateTotal();
			closePopup();
		}
		function getProvincesName(provinceCode) {
		    return new Promise((resolve, reject) => {
		        $.ajax({
		            url: "https://provinces.open-api.vn/api/p",  // API lấy toàn bộ tỉnh/thành phố
		            type: "GET",
		            success: function(data) {
		                const province = data.find(province => province.code == provinceCode);
		                if (province) {
		                    resolve(province.name); // Trả về tên tỉnh/thành phố
		                } else {
		                    reject(`Không tìm thấy tỉnh/thành phố với mã: ${provinceCode}`);
		                }
		            },
		            error: function() {
		                reject("Lỗi khi tải dữ liệu tỉnh/thành phố.");
		            }
		        });
		    });
		}



		function getDistrictName(districtCode) {
		    return new Promise((resolve, reject) => {
		        $.ajax({
		            url: "https://provinces.open-api.vn/api/d", // API lấy danh sách các quận/huyện
		            type: "GET",
		            success: function(data) {
		                // Tìm quận/huyện dựa trên districtCode
		                const district = data.find(district => district.code == districtCode);
		                if (district) {
		                    resolve(district.name); // Trả về tên quận/huyện
		                } else {
		                    reject(`Không tìm thấy quận/huyện với mã: ${districtCode}`);
		                }
		            },
		            error: function() {
		                reject("Lỗi khi tải dữ liệu quận/huyện.");
		            }
		        });
		    });
		}


		function getWardName(wardCode) {
		    return new Promise((resolve, reject) => {
		        $.ajax({
		            url: "https://provinces.open-api.vn/api/w",  // API lấy danh sách xã/phường
		            type: "GET",
		            success: function(data) {
		                // Tìm xã/phường dựa trên wardCode
		                const ward = data.find(ward => ward.code == wardCode);
		                if (ward) {
		                    resolve(ward.name); // Trả về tên xã/phường
		                } else {
		                    reject(`Không tìm thấy xã/phường với mã: ${wardCode}`);
		                }
		            },
		            error: function() {
		                reject("Lỗi khi tải dữ liệu xã/phường.");
		            }
		        });
		    });
		}
		async function saveAddress() {
		    // Lấy giá trị từ các trường input
		    const uname = document.getElementById("uname").value;
		    const phone = document.getElementById("phone").value;
		    const provinceCode = document.getElementById("province").value;
		    const districtCode = document.getElementById("district").value;
		    const wardCode = document.getElementById("ward").value;
		    const detail = document.getElementById("detail").value;

		    try {
		        // Lấy tên tỉnh, huyện, xã từ các API bất đồng bộ
		        const province = await getProvincesName(provinceCode);
		        const district = await getDistrictName(districtCode);
		        const ward = await getWardName(wardCode);

		        // Tạo object addressData
		        const addressData = {
		            uname: uname,
		            phone: phone,
		            province: province,
		            district: district,
		            ward: ward,
		            detail: detail
		        };
		        // Gửi dữ liệu qua AJAX
		        $.ajax({
		            url: '/user/api/address/save', // Địa chỉ API
		            type: 'POST',
		            contentType: 'application/json',
		            data: JSON.stringify(addressData), // Dữ liệu gửi đi dưới dạng JSON
		            success: function(response) {
		                // Tạo một HTML mới cho địa chỉ vừa thêm
		                const newAddressHTML = `
		                    <div class="col-6 address">
		                        <div class="align-items-start" style="padding: 10px; height: 100%">
		                            <div style="padding: 10px; height: 80%">
		                                <p><strong>${addressData.uname}</strong></p>
		                                <p>${addressData.phone}</p>
		                                <p>${addressData.detail} ${addressData.ward} ${addressData.district} ${addressData.province}</p>
		                            </div>
		                            <div class="d-flex" style="height: 20%; width: 100%; justify-content: flex-end; display: flex;">
		                                <i class="fa-solid fa-pencil-alt" style="padding-right: 10px;"></i>
		                                <i class="fa-solid fa-trash-alt" style="padding-right: 10px;"></i>
		                                <a>Mac dinh</a>
		                            </div>
		                        </div>
		                    </div>
		                `;

		                // Chèn vào container chứa các địa chỉ
		                $('.row-address').append(newAddressHTML);

		                // Hiển thị thông báo
		                alert("Địa chỉ đã được lưu thành công!");
		            },
		            error: function(error) {
		                alert("Có lỗi xảy ra: " + error.responseText);
		            }
		        });
		    } catch (error) {
		        // Xử lý lỗi nếu API không lấy được tên tỉnh, huyện, xã
		        console.error("Lỗi khi lấy dữ liệu:", error);
		        alert("Không thể lưu địa chỉ. Vui lòng kiểm tra lại thông tin.");
		    }
		}
		// Gán sự kiện
		document.querySelectorAll('.changeButton').forEach(button => {
			button.addEventListener("click", openPopup);
		});

		document.querySelectorAll('.confirm-button').forEach(button => {
			button.addEventListener("click", confirmSelection);
			button.addEventListener("click", closePopup);
		});
		
		document.querySelectorAll('.saveAddressBtn').forEach(button => {
			button.addEventListener("click", saveAddress); 
			button.addEventListener("click", closeAddressModel);
		});
		
		document.querySelectorAll('.close-button').forEach(button => {
			button.addEventListener("click", closePopup);
		});
		document.querySelectorAll('.remove-address').forEach(button => {
			button.addEventListener("click", removeAddress);
		});
		function updateTotal() {
			let totalItems = 0;
			let totalShipping = 0;

			// Lấy tổng tiền hàng và phí vận chuyển từ tất cả các sản phẩm
			document.querySelectorAll('.product-info').forEach(product => {
				const productPriceText = product.querySelector('.title-sp-1').textContent;
				const productPrice = parseFloat(productPriceText.replace(/[^0-9.]/g, ''));
			    const productQuantity = parseInt(product.querySelectorAll('.title-sp-1')[1].textContent.trim(), 10) || 0;
				const shippingCost = parseInt(product.querySelector('.shippingCost').textContent.replace(/\D/g, '')); // Phí vận chuyển

				totalItems += productPrice * productQuantity;
				totalShipping += shippingCost;
			});

			// Cập nhật giá trị tổng tiền hàng, phí vận chuyển và tổng thanh toán
			document.querySelector('.tien-tong-items').textContent = totalItems.toLocaleString() + "₫";
			document.querySelector('.tien-tong-shipping').textContent = totalShipping.toLocaleString() + "₫";
			document.querySelector('.tien-tong-total').textContent = (totalItems + totalShipping).toLocaleString() + "₫";
		}
		function updateTotalForOrder(orderElement) {
		    let totalItems = 0;
		    let shippingCost = 0;

		    // Tìm các phần tử liên quan trong đơn hàng cụ thể
		    const productPriceText = orderElement.querySelector('.title-sp-1').textContent;

			// Parse the number, removing any non-numeric characters (e.g., commas or periods)
			const productPrice = parseFloat(productPriceText.replace(/[^0-9.]/g, ''));
		    const productQuantity = parseInt(orderElement.querySelectorAll('.title-sp-1')[1].textContent.trim(), 10) || 0;

		    const totalItemElement = orderElement.querySelector('#total');
		    // Tính tổng tiền cho sản phẩm
		    totalItems = productPrice * productQuantity;
		    totalItemElement.textContent = totalItems.toLocaleString() + "₫";
		    // Tính chi phí vận chuyển
		    shippingCost = parseInt(orderElement.querySelector('.shippingCost').textContent.replace(/\D/g, ''), 10) || 0;

		    // Tính tổng thanh toán
		    const total = totalItems + shippingCost;

		    // Cập nhật tổng tiền cho đơn hàng này
		    const totalElement = orderElement.querySelector('.tongtien span');
		    if (totalElement) {
		        totalElement.textContent = "Tổng tiền: " + total.toLocaleString() + "₫";
		    }
		}
		window.addEventListener('load', () => {
			document.querySelectorAll('.product-info').forEach(order => {
				updateTotalForOrder(order);
			});
		});
		document.querySelectorAll('.btn-tt').forEach(button => {
			button.addEventListener('click', function (event) {
				event.stopPropagation();

				if (!this.classList.contains('active-btn')) {
					document.querySelectorAll('.btn-tt').forEach(btn => btn.classList.remove('active-btn'));
					this.classList.add('active-btn'); 
				}
			});
		});
	</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<!-- rts cart area end -->
		<div th:replace="~{page/fragments/footer2::footer2}"></div>
		<!-- progress area end -->
		<!-- plugins js -->
		<script defer src="/view/js/plugins.js"></script>
		<!-- custom js -->
		<script defer src="/view/js/main.js"></script>
		<!-- header style two End -->
</body>

</html>
